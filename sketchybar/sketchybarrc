#!/usr/bin/env bash
# Source: github.com/Kcraft059/sketchybar-config

export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:/run/current-system/sw/bin:$HOME/.local/bin:$HOME/.nix-profile/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$PATH"

RELPATH="$HOME/.config/sketchybar"
source "$RELPATH/plugins/icon_map.sh"

FONT="SF Pro"

BAR_COLOR=0xee1e1e2e
ACCENT=0xffcba6f7
TEXT=0xffcdd6f4
SUBTLE=0xff6c7086
SURFACE=0xff313244
HIGHLIGHT=0xfff38ba8
ACTIVE_BG=0xff45475a

sketchybar --bar height=40 \
                 y_offset=6 \
                 margin=8 \
                 position=top \
                 sticky=on \
                 padding_left=12 \
                 padding_right=12 \
                 color=$BAR_COLOR \
                 corner_radius=12 \
                 blur_radius=30 \
                 shadow=on

sketchybar --default updates=when_shown \
                     icon.font="$FONT:Bold:14.0" \
                     icon.color=$TEXT \
                     label.font="$FONT:Semibold:13.0" \
                     label.color=$TEXT \
                     padding_left=4 \
                     padding_right=4 \
                     icon.padding_left=8 \
                     icon.padding_right=6 \
                     label.padding_left=6 \
                     label.padding_right=8 \
                     background.height=28 \
                     background.corner_radius=8

sketchybar --add event aerospace_workspace_change
sketchybar --add event system_stats

for sid in 1 2 3 4 5 6 7 8 9; do
    sketchybar --add item space.$sid left \
        --subscribe space.$sid aerospace_workspace_change mouse.clicked \
        --set space.$sid \
            icon="$sid" \
            updates=on \
            icon.font="$FONT:Bold:13.0" \
            icon.color=$SUBTLE \
            icon.highlight_color=$BAR_COLOR \
            icon.padding_left=10 \
            icon.padding_right=10 \
            background.color=$SURFACE \
            background.corner_radius=6 \
            background.height=24 \
            background.drawing=off \
            label.font="sketchybar-app-font:Regular:14.0" \
            label.color=$TEXT \
            label.padding_right=12 \
            label.drawing=off \
            click_script="aerospace workspace $sid" \
            script="$RELPATH/plugins/spaces/aerospace/script-space.sh $sid"
done

# Separator arrow removed (was icon=ô€†Š)

sketchybar --add item front_app center \
           --set front_app icon.drawing=off \
                          label.font="$FONT:Semibold:13.0" \
                          label.color=$TEXT \
                          background.drawing=off \
                          script="$RELPATH/plugins/front_app/script.sh" \
           --subscribe front_app front_app_switched

sketchybar --add item calendar right \
           --set calendar icon="$(date '+%a %d %b')" \
                         label="$(date '+%H:%M')" \
                         icon.font="$FONT:Semibold:10.0" \
                         icon.color=$ACCENT \
                         label.font="$FONT:Bold:10.0" \
                         icon.padding_left=6 \
                         icon.padding_right=4 \
                         label.padding_left=0 \
                         label.padding_right=6 \
                         background.color=$SURFACE \
                         background.drawing=on \
                         update_freq=30 \
                         click_script="open -a Calendar" \
                         script="$RELPATH/plugins/calendar/script.sh"

sketchybar --add item events right \
           --set events icon=ô€‰‰ \
                       icon.color=$ACCENT \
                       icon.font="$FONT:Bold:11.0" \
                       icon.padding_left=6 \
                       icon.padding_right=2 \
                       label.font="$FONT:Regular:9.0" \
                       label.color=$TEXT \
                       label.max_chars=25 \
                       label.padding_left=0 \
                       label.padding_right=6 \
                       background.color=$SURFACE \
                       background.drawing=on \
                       update_freq=300 \
                       click_script="open -a Calendar" \
                       script="$RELPATH/plugins/calendar/events.sh"

sketchybar --add item cpu right \
           --set cpu icon="CPU" \
                    icon.font="$FONT:Bold:8.0" \
                    icon.color=$ACCENT \
                    label="--" \
                    label.font="$FONT:Semibold:8.0" \
                    label.color=$TEXT \
                    padding_left=0 \
                    padding_right=0 \
                    icon.padding_left=4 \
                    icon.padding_right=2 \
                    label.padding_left=0 \
                    label.padding_right=4 \
                    background.drawing=off \
                    script="$RELPATH/plugins/system_stats/script.sh" \
           --subscribe cpu system_stats

sketchybar --add graph cpu_graph right 16 \
           --set cpu_graph graph.color=$ACCENT \
                         graph.fill_color=0x33cba6f7 \
                         graph.line_width=1.0 \
                         background.height=22 \
                         background.drawing=off \
                         padding_left=0 \
                         padding_right=0

sketchybar --add bracket cpu_stats cpu cpu_graph \
           --set cpu_stats background.color=$SURFACE \
                          background.drawing=on \
                          padding_left=0 \
                          padding_right=0

sketchybar --add item ram right \
           --set ram icon="RAM" \
                    icon.font="$FONT:Bold:8.0" \
                    icon.color=$HIGHLIGHT \
                    label="--" \
                    label.font="$FONT:Semibold:8.0" \
                    label.color=$TEXT \
                    padding_left=0 \
                    padding_right=0 \
                    icon.padding_left=4 \
                    icon.padding_right=2 \
                    label.padding_left=0 \
                    label.padding_right=4 \
                    background.drawing=off

sketchybar --add slider ram_graph right 16 \
           --set ram_graph slider.background.drawing=on \
                          slider.background.color=$BAR_COLOR \
                          slider.background.height=22 \
                          slider.background.corner_radius=6 \
                          slider.highlight_color=0x88f38ba8 \
                          slider.knob.drawing=off \
                          slider.percentage=0 \
                          background.drawing=off \
                          padding_left=0 \
                          padding_right=0

sketchybar --add bracket ram_stats ram ram_graph \
           --set ram_stats background.color=$SURFACE \
                          background.drawing=on \
                          padding_left=0 \
                          padding_right=0

sketchybar --add item wifi right \
           --set wifi icon=ô€™‡ \
                     icon.color=$ACCENT \
                     label.drawing=off \
                     padding_left=0 \
                     padding_right=0 \
                     background.color=$SURFACE \
                     background.drawing=on \
                     click_script="$RELPATH/plugins/wifi/click.sh" \
                     script="$RELPATH/plugins/wifi/script.sh" \
           --subscribe wifi wifi_change

sketchybar --add item bluetooth right \
	           --set bluetooth icon=ô€ª· \
	                          icon.color=$ACCENT \
	                          label.color=$TEXT \
	                          label.font="$FONT:Semibold:11.0" \
	                          background.color=$SURFACE \
	                          background.drawing=on \
	                          update_freq=30 \
	                          click_script="$RELPATH/plugins/bluetooth/click.sh" \
	                          script="$RELPATH/plugins/bluetooth/script.sh"

sketchybar --add item codexbar right \
           --set codexbar icon="ðŸŽšï¸" \
                          label.drawing=off \
                          background.color=$SURFACE \
                          background.drawing=on \
                          click_script="$RELPATH/plugins/codexbar/click.sh"

sketchybar --add item repobar right \
           --set repobar icon="ðŸ“Š" \
                         label.drawing=off \
                         background.color=$SURFACE \
                         background.drawing=on \
                         click_script="$RELPATH/plugins/repobar/click.sh"

sketchybar --add item portkiller right \
           --set portkiller icon="ðŸ”Œ" \
                           label.drawing=off \
                           background.color=$SURFACE \
                           background.drawing=on \
                           click_script="$RELPATH/plugins/portkiller/click.sh"

if [ -x "/Applications/CMatrixWallpaper.app/Contents/MacOS/matrixdaemon" ]; then
    sketchybar --add item matrix_wallpaper right \
               --set matrix_wallpaper icon="M" \
                                      icon.color=$ACCENT \
                                      label.color=$TEXT \
                                      label.font="$FONT:Semibold:11.0" \
                                      background.color=$SURFACE \
                                      background.drawing=on \
                                      update_freq=30 \
                                      click_script="$RELPATH/plugins/matrix_wallpaper/click.sh" \
                                      script="$RELPATH/plugins/matrix_wallpaper/script.sh"
fi

if command -v stats_provider >/dev/null 2>&1; then
  killall stats_provider >/dev/null 2>&1 || true
  stats_provider --cpu usage --memory ram_usage --interval 2 --no-units >/dev/null 2>&1 &
fi

sketchybar --update

echo "sketchybar configuration loaded"
